<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8" />
<title>Sales Cabang AIGOLAII</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js"></script>

<!-- Charts & Excel -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<style>
  body { font-family:sans-serif; padding:20px; }
  input, select, button { margin:5px; padding:5px; }
  table { width:100%; border-collapse:collapse; margin-top:20px; }
  th, td { border:1px solid #ccc; padding:8px; text-align:center; }
  canvas { max-width:100%; margin-top:30px; }
</style>
</head>
<body>

<h2>📊 Sales Cabang AIGOLAII</h2>

<div id="adminForm" style="display:none;">
  <input type="date" id="tanggal">
  <select id="cabang"></select>
  <select id="produk"></select>
  <input type="number" id="jumlah" placeholder="Jumlah">
  <button id="tombolInput" onclick="tambahData()">Tambah Data</button>
</div>

<div class="filter-bar">
  <label>Filter Cabang:</label>
  <select id="filterCabang" onchange="tampilkanData()"></select>
  <label>Filter Bulan:</label>
  <input type="month" id="filterBulan" onchange="tampilkanData()">
  <button onclick="downloadExcel()">⬇ Export Excel</button>
</div>

<table id="tabelData">
  <thead><tr><th>Tanggal</th><th>Cabang</th><th>Produk</th><th>Jumlah</th><th>Aksi</th></tr></thead>
  <tbody></tbody>
</table>

<canvas id="grafik"></canvas>

<h3>🏆 Peringkat Pencapaian Target</h3>
<table id="tabelRingkasan">
  <thead><tr><th>Ranking</th><th>Cabang</th><th>Total</th><th>Target</th><th>Pencapaian (%)</th></tr></thead>
  <tbody></tbody>
</table>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCGdq6VcFsChH0d_Y5BhmqqXqhlJiWfiG4",
  authDomain: "aigolaii-sales-app.firebaseapp.com",
  projectId: "aigolaii-sales-app",
  storageBucket: "aigolaii-sales-app.firebasestorage.app",
  messagingSenderId: "539354967572",
  appId: "1:539354967572:web:97c0228742172e9409c101"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let data = [], isAdmin = false, modeEdit = false, indexEdit = null;

const targetPerCabang = {
  "Bekasi 1": 55, "Bekasi 2": 55, "Bekasi 3": 55, "Bintaro": 55, "BSD": 55, "Cawang": 55,
  "Cengkareng": 55, "Garut": 55, "Jogja": 55, "Padang": 55, "Pondok Gede": 55, "Sibolga": 55,
  "Cikarang": 55, "Cileungsi": 55, "Jaksel": 55, "Tele HO": 55
};

const cabangs = Object.keys(targetPerCabang),
      produkList = ["KKB Mobil","KSM Motor","Multiguna"];

cabangs.forEach(c => { let o=document.createElement('option'); o.value=o.textContent=c;
  document.getElementById('cabang').appendChild(o); document.getElementById('filterCabang').appendChild(o.cloneNode(true)); });
produkList.forEach(p => { let o=document.createElement('option'); o.value=o.textContent=p; document.getElementById('produk').appendChild(o); });

loadData();

async function loadData() {
  data = [];
  const snapshot = await db.collection('penjualan').get();
  snapshot.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
  tampilkanData();
}

function tampilkanData() {
  const tbody=document.querySelector("#tabelData tbody"); tbody.innerHTML="";
  const fCabang=document.getElementById('filterCabang').value;
  const fBulan=document.getElementById('filterBulan').value;
  const filtered=data.filter(d =>
    (!fCabang || d.cabang===fCabang) &&
    (!fBulan || d.tanggal.startsWith(fBulan))
  );
  filtered.forEach((d,i)=>tbody.innerHTML+=
    `<tr><td>${d.tanggal}</td><td>${d.cabang}</td><td>${d.produk}</td><td>${d.jumlah}</td><td>${isAdmin?`<button onclick="editData(${i})">✏️</button><button onclick="hapusData(${i})">🗑️</button>`:''}</td></tr>`
  );
  updateChart(filtered); tampilkanRingkasan(filtered);
}

function editData(i) {
  const d=data[i]; document.getElementById('tanggal').value=d.tanggal;
  document.getElementById('cabang').value=d.cabang; document.getElementById('produk').value=d.produk;
  document.getElementById('jumlah').value=d.jumlah; modeEdit=true; indexEdit=i;
  document.getElementById('tombolInput').textContent='Update Data';
}

async function hapusData(i) {
  if(!confirm('Yakin hapus?')) return;
  await db.collection('penjualan').doc(data[i].id).delete();
  loadData();
}

async function tambahData() {
  const tanggal=document.getElementById('tanggal').value;
  const cabang=document.getElementById('cabang').value;
  const produk=document.getElementById('produk').value;
  const jumlah=parseInt(document.getElementById('jumlah').value);
  if(!tanggal||!cabang||!produk||isNaN(jumlah)) return alert('Lengkapi semua data');

  if(modeEdit){
    await db.collection('penjualan').doc(data[indexEdit].id).update({tanggal,cabang,produk,jumlah});
    modeEdit=false; indexEdit=null; document.getElementById('tombolInput').textContent='Tambah Data';
  }else{
    await db.collection('penjualan').add({tanggal,cabang,produk,jumlah});
  }
  loadData();
  ['tanggal','cabang','produk','jumlah'].forEach(id=>document.getElementById(id).value='');
}

function updateChart(filtered) {
  const totals={}; filtered.forEach(d=>totals[d.cabang]=(totals[d.cabang]||0)+d.jumlah);
  if(window.barChart) window.barChart.destroy();
  window.barChart=new Chart(document.getElementById('grafik').getContext('2d'),{
    type:"bar",
    data:{labels:Object.keys(totals), datasets:[{label:"Total Penjualan",data:Object.values(totals),backgroundColor:"rgba(54,162,235,0.6)"}]}
  });
}

function tampilkanRingkasan(filtered) {
  const ringkasan={}; filtered.forEach(d=>ringkasan[d.cabang]=(ringkasan[d.cabang]||0)+d.jumlah);
  const hasil=Object.entries(ringkasan).map(([cabang,total])=>{
    const target=targetPerCabang[cabang]||0; return {cabang,total,target,persen:target?((total/target)*100).toFixed(1):0};
  }).sort((a,b)=>b.persen-a.persen);
  const tbody=document.querySelector("#tabelRingkasan tbody"); tbody.innerHTML="";
  hasil.forEach((item,i)=>tbody.innerHTML+=
    `<tr><td>${i+1}</td><td>${item.cabang}</td><td>${item.total}</td><td>${item.target}</td><td>${item.persen}%</td></tr>`
  );
}

function downloadExcel() {
  const ws=XLSX.utils.json_to_sheet(data); const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Penjualan"); XLSX.writeFile(wb,"data_penjualan.xlsx");
}

document.addEventListener('keydown',e=>{
  if(e.ctrlKey&&e.shiftKey&&e.key==='A'){
    if(prompt('Password admin:')==='aigolasecret'){isAdmin=true;document.getElementById('adminForm').style.display='block';tampilkanData();}
    else alert('❌ Password Salah');
  }
});
</script>
</body>
</html>
